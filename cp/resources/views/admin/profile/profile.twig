{% extends "layouts/app.twig" %}

{% block title %}{{ __('My Profile') }}{% endblock %}

{% block content %}
      <div class="page-wrapper">
        <!-- Page header -->
        <div class="page-header d-print-none">
          <div class="container-xl">
            <div class="row g-2 align-items-center">
              <div class="col">
                <!-- Page pre-title -->
                <div class="page-pretitle">
                  {{ __('Overview') }}
                </div>
                <h2 class="page-title">
                  {{ __('My Profile') }}
                </h2>
              </div>
            </div>
          </div>
        </div>
        <!-- Page body -->
        <div class="page-body">
          <div class="container-xl">
            <div class="card">
              <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
                  <li class="nav-item">
                    <a href="#tabs-details" class="nav-link active" data-bs-toggle="tab">Details</a>
                  </li>
                  <li class="nav-item">
                    <a href="#tabs-2fa" class="nav-link" data-bs-toggle="tab">2FA</a>
                  </li>
                  <li class="nav-item">
                    <a href="#tabs-webauthn" class="nav-link" data-bs-toggle="tab">WebAuthn</a>
                  </li>
                </ul>
              </div>
              <div class="card-body">
                <div class="tab-content">
                  <div class="tab-pane active show" id="tabs-details">
                    <h4 class="card-title">{{ __('Details') }}</h4>
                    <div class="card">
                      <div class="card-body">
                        <form action="{{route('change.password')}}" name="register" method="post">
                            {{ csrf.field | raw }}
                            <div class="row g-3">
                              <div class="col-md">
                                <div class="form-label">{{ __('User Name') }}</div>
                                <div class="form-control-plaintext">{{ username }}</div>
                              </div>
                              <div class="col-md">
                                <div class="form-label">{{ __('Email') }}</div>
                                <div class="form-control-plaintext">{{ email }}</div>
                              </div>
                              <div class="col-md">
                                <div class="form-label">{{ __('Status') }}</div>
                                <span class="badge bg-green text-bg-green mt-2">{{ status }}</span>
                              </div>
                              <div class="col-md">
                                <div class="form-label">{{ __('Role') }}</div>
                                <span class="badge bg-blue text-bg-blue mt-2">{{ role }}</span>
                              </div>
                            </div>
                            <h3 class="card-title mt-4">{{ __('Change Password') }}</h3>
                            <div class="row g-3">
                              <div class="col-md">
                                <div class="form-label required">{{ __('Old Password') }}</div>
                                <input type="password" class="form-control{{ errors.old_password ? ' is-invalid' : '' }}" name="old_password" placeholder="Enter old password" required>
                                {% if errors.old_password %}
                                    <small class="form-hint">{{ errors.old_password | first }}</small>
                                {% endif %}
                              </div>
                              <div class="col-md">
                                <div class="form-label required">{{ __('New Password') }}</div>
                                <input type="password" class="form-control{{ errors.new_password ? ' is-invalid' : '' }}" name="new_password" placeholder="Enter new password" required>
                                {% if errors.new_password %}
                                    <small class="form-hint">{{ errors.new_password | first }}</small>
                                {% endif %}
                              </div>
                            </div>
                      </div>
                      <div class="card-footer bg-transparent mt-auto">
                        <div class="btn-list justify-content-end">
                          <a href="{{route('home')}}" class="btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 11l-4 4l4 4m-4 -4h11a4 4 0 0 0 0 -8h-1"></path></svg> {{ __('Back') }}
                          </a>
                          <button type="submit" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"></path><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path></svg> {{ __('Update') }}
                          </button>
                        </div>
                      </div>
                      </form>
                    </div>
                  </div>
                  <div class="tab-pane" id="tabs-2fa">
                    <h4 class="card-title">Two-Factor Authentication (2FA)</h4>
                        <div class="card">
                            {% if secret is defined %}
                            <form action="{{route('activate2fa')}}" name="2fa" method="post">
                            {{ csrf.field | raw }}
                            <div class="card-body">
                                <p>Set up 2FA for additional security. Scan the QR code with your authentication app and enter the provided code below to verify.</p>
                                <!-- QR Code Placeholder -->
                                <div class="mb-3">
                                    <img src="{{ qrcodeDataUri }}" alt="2FA QR Code" class="img-fluid">
                                </div>
                                <!-- Secret for Manual Entry -->
                                <div class="mb-3">
                                    <p class="font-weight-bold">Manual Entry Secret</p>
                                    <code>{{ secret|split(4)|join(' ') }}</code>
                                    <small class="form-text text-muted">
                                        If you're unable to scan the QR code, enter this secret manually into your authentication app. The secret is case-sensitive and should be entered exactly as shown.
                                    </small>
                                </div>
                                <!-- Verification Code Input -->
                                <div class="mb-3">
                                    <label for="verificationCode" class="form-label required">Verification Code</label>
                                    <input type="number" class="form-control" id="verificationCode" name="verificationCode" placeholder="Enter code" required="required">
                                    <small class="form-text text-muted">
                                        Enter the code generated by your authentication app. This code verifies that your 2FA setup is working correctly. Once entered, click 'Save 2FA Settings' to activate two-factor authentication for your account.
                                    </small>
                                </div>
                                <!-- Save Button -->
                                <button type="submit" class="btn btn-primary">Save 2FA Settings</button>
                            </div>
                            </form>
                            {% else %}
                            <div class="card-body">
                                <p>2FA active</p>
                            </div>
                            {% endif %}
                        </div>
                  </div>
                  <div class="tab-pane" id="tabs-webauthn">
                    <h4 class="card-title">WebAuthn Authentication</h4>
                    <div class="card">
                        <div class="card-body">
                            <p>Secure your account with WebAuthn. Click the button below to register your device for passwordless sign-in.</p>
                            <!-- Connect WebAuthn Button -->
                            <button type="button" class="btn btn-success" id="connectWebAuthnButton">Connect WebAuthn Device</button>
                            <!-- WebAuthn Devices Table -->
                            <div class="table-responsive mt-4">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Device Name</th>
                                            <th>Registration Date</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dynamically populated rows go here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                  </div>
                </div>
            </div>
          </div>
        </div>
        <footer class="footer footer-transparent d-print-none">
          <div class="container-xl">
              <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                <ul class="list-inline list-inline-dots mb-0">
                  <li class="list-inline-item">
                    Copyright &copy; 2023
                    <a href="https://getpinga.com" class="link-secondary">Pinga</a>.
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </footer>
      </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const connectButton = document.getElementById('connectWebAuthnButton');

    connectButton.addEventListener('click', async function() {
        try {
            // Step 1: Get the registration challenge from the server
            const response = await fetch('/webauthn/register/challenge');
            const data = await response.json();

            // Decode the challenge and user ID from Base64 to Uint8Array
            const challenge = Uint8Array.from(atob(data.publicKey.challenge), c => c.charCodeAt(0));
            const userId = Uint8Array.from(atob(data.publicKey.user.id), c => c.charCodeAt(0));

            // Modify the data object to use the decoded challenge and user ID
            data.publicKey.challenge = challenge;
            data.publicKey.user.id = userId;

            // Step 2: Call WebAuthn API to create credentials
            const credentials = await navigator.credentials.create(data);

            // Prepare credentials response
            const publicKeyCredential = {
                id: credentials.id,
                rawId: btoa(String.fromCharCode.apply(null, new Uint8Array(credentials.rawId))),
                type: credentials.type,
                response: {
                    attestationObject: btoa(String.fromCharCode.apply(null, new Uint8Array(credentials.response.attestationObject))),
                    clientDataJSON: btoa(String.fromCharCode.apply(null, new Uint8Array(credentials.response.clientDataJSON)))
                },
                // Include CSRF tokens in the payload
                csrf_name: '{{ csrf_name }}',
                csrf_value: '{{ csrf_value }}'
            };

            // Step 3: Send the credentials back to the server for verification
            const verificationResponse = await fetch('/webauthn/register/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(publicKeyCredential)
            });

            if(verificationResponse.ok) {
                alert('Registration successful!');
                window.location.reload();
            } else {
                const errorData = await verificationResponse.json();
                alert('Registration failed: ' + (errorData.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error during WebAuthn registration:', error);
            alert('Error during registration: ' + error.message);
        }
    });
});
</script>
{% endblock %}